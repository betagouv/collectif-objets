- content_for(:head_title) { "Activer la 2FA" }

%main#contenu.fr-container.fr-pt-2w.fr-pb-4w
  = render("shared/breadcrumbs", links: [["Administration", admin_path], ["Admins", admin_admin_users_path], [current_admin_user.to_s, admin_admin_user_path(current_admin_user)]], current_page_label: "Activer la 2FA")

  %h1 Activer l'authentification à deux facteurs

  .fr-grid-row
    .fr-col-md-8
      .fr-alert.fr-alert--info.fr-mb-4w
        %p.fr-alert__title Configuration 2FA
        %p
          Configurez votre application d'authentification (Google Authenticator, Authy, 1Password, etc.)
          en scannant le QR code ou en saisissant manuellement la clé secrète.

      - if @qr_code
        .fr-mb-4w
          = dsfr_accordion do |accordion|
            = accordion.with_section(title: "Scannez ce QR code avec votre application d'authentification", expanded: true) do
              .fr-mb-2w{ style: "text-align: center;" }
                = @qr_code.html_safe
            = accordion.with_section(title: "Je ne peux pas scanner le QR code") do
              %p.fr-text--sm.fr-mb-2w
                Saisissez cette clé manuellement dans votre application d'authentification.
                %br
                Type de compte : TOTP (basé sur le temps)
              .fr-input-group
                %label.fr-label{ for: "otp-secret-input" } Clé secrète
                .fr-input-wrap.fr-input-wrap--addon
                  %input.fr-input{ type: "text", value: @admin_user.otp_secret, readonly: true }
                  %button.fr-btn.fr-btn--icon-left.fr-icon-todo-line{ type: :button, data: { controller: :clipboard, action: "clipboard#copy", "clipboard-content-value": @admin_user.otp_secret } }
                    Copier

      %p Ensuite, saisissez ci-dessous le code à 6 chiffres affiché dans l'application et votre mot de passe.

      = form_with url: confirm_admin_admin_user_two_factor_settings_path(@admin_user), method: :post do |f|
        .fr-input-group{ "data-controller": "password-visibility" }
          = f.label :password, class: "co-flex co-flex--space-between" do
            Mot de passe
            %button.fr-btn.fr-btn--tertiary.fr-btn--icon-left.fr-fi-eye-line{ type: :button, data: { action: "password-visibility#toggle", "password-visibility-target": :button } }
              Afficher
          = f.password_field :password, class: "fr-input", required: true, autocomplete: "current-password", "data-password-visibility-target": :input
        .fr-input-group
          = f.label :otp_attempt, "Code de vérification", class: "fr-label"
          = f.text_field :otp_attempt, class: "fr-input", required: true, autocomplete: "one-time-code", placeholder: "123456"
        .fr-mt-2w
          = f.submit "Activer 2FA", class: "fr-btn"
